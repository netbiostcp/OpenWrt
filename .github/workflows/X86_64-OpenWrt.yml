name: Build OpenWrt Firmware

on:
  # å…è®¸æ‰‹åŠ¨ä» GitHub Actions ç•Œé¢è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

  # æ¯å‘¨æ—¥ UTC æ—¶é—´ 00:00 è‡ªåŠ¨è§¦å‘ç¼–è¯‘
  schedule:
    - cron: '0 0 * * 0'

  # (å¯é€‰) å½“ä»£ç æ¨é€åˆ° 'main' æˆ– 'master' åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  # å¦‚æœä½ é¢‘ç¹ä¿®æ”¹ä»£ç ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å¤§é‡æ„å»º
  # push:
  #   branches:
  #     - main
  #     - master

env:
  # OpenWrt æºç ä»“åº“ URLï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ coolsnowwolf/lede
  REPO_URL: https://github.com/coolsnowwolf/lede
  # OpenWrt æºç åˆ†æ”¯
  REPO_BRANCH: master
  # ä½ çš„è‡ªå®šä¹‰ .config æ–‡ä»¶åï¼Œä½äºä½ çš„ GitHub ä»“åº“æ ¹ç›®å½•
  CONFIG_FILE: .config
  # ä½ çš„è‡ªå®šä¹‰è„šæœ¬æ–‡ä»¶ï¼Œç”¨äºåœ¨ç¼–è¯‘å‰è¿›è¡Œé¢å¤–ä¿®æ”¹
  DIY_SCRIPT: diy-script.sh
  # æ—¶åŒºè®¾ç½®ï¼Œç”¨äºæ—¥å¿—æ—¶é—´æˆ³
  TZ: Asia/Shanghai

  # --- å›ºä»¶å‘å¸ƒå’Œç¼“å­˜é€‰é¡¹ ---
  # æ˜¯å¦ä¸Šä¼ ç¼–è¯‘åçš„æ•´ä¸ª 'bin' ç›®å½•ä½œä¸º GitHub Artifacts (é€šå¸¸åªä¸Šä¼ å›ºä»¶å³å¯)
  UPLOAD_BIN_DIR: false
  # æ˜¯å¦åˆ›å»º GitHub Release
  FIRMWARE_RELEASE: true
  # Release çš„æ ‡ç­¾åï¼Œä¾‹å¦‚ 'X86_64'
  FIRMWARE_TAG: X86_64
  # æ˜¯å¦ä½¿ç”¨ç¼“å­˜æ¥åŠ é€Ÿç¼–è¯‘ (æ¨èå¼€å¯)
  CACHE_TOOLCHAIN: true
  # Clash å†…æ ¸ç±»å‹ï¼Œå¦‚æœä½ çš„ DIY_SCRIPT ä¸­æœ‰ç›¸å…³é…ç½®
  CLASH_KERNEL: amd64

jobs:
  Build:
    # è¿è¡Œå·¥ä½œæµçš„æ“ä½œç³»ç»Ÿç¯å¢ƒï¼Œæ¨èä½¿ç”¨æœ€æ–°çš„ Ubuntu LTS
    runs-on: ubuntu-22.04

    steps:
    - name: ğŸš€ Free Disk Space (Optional but Recommended)
      # æ¸…ç† GitHub Actions runner ä¸Šé¢„è£…çš„ä¸å¿…è¦è½¯ä»¶ï¼Œä»¥èŠ‚çœç£ç›˜ç©ºé—´
      # å¯¹äºå¤§å‹ç¼–è¯‘é¡¹ç›®ï¼ˆå¦‚ OpenWrtï¼‰éå¸¸æœ‰å¸®åŠ©
      run: |
        echo "::group::Freeing up disk space"
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        echo "::endgroup::"
        df -h

    - name: ğŸ”§ Install Build Dependencies
      # å®‰è£…ç¼–è¯‘ OpenWrt æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–å·¥å…·å’Œåº“
      # è¿™æ˜¯æœ€å…³é”®çš„æ­¥éª¤ä¹‹ä¸€ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€çš„æ„å»ºç¯å¢ƒéƒ½å¯ç”¨
      run: |
        echo "::group::Installing build dependencies"
        sudo -E apt-get update
        sudo -E apt-get -y install build-essential git libncurses5-dev zlib1g-dev gawk flex unzip file wget \
                                 libssl-dev python3 python3-distutils rsync subversion mercurial locales
        sudo timedatectl set-timezone "$TZ" # è®¾ç½®æ—¶åŒº
        echo "::endgroup::"

    - name: ğŸ“¥ Checkout Workflow Repository
      # å…‹éš†ä½ çš„ GitHub ä»“åº“ï¼Œä»¥ä¾¿è·å–ä½ ä¸Šä¼ çš„ .config æ–‡ä»¶å’Œ diy-script.sh
      uses: actions/checkout@v4

    - name: â¬‡ï¸ Clone OpenWrt Source Code
      # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„ OpenWrt æºç åˆ° 'openwrt' ç›®å½•
      run: |
        echo "::group::Cloning OpenWrt source"
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        # å°† OpenWrt æºç çš„ç»å¯¹è·¯å¾„è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤å¼•ç”¨
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        echo "::endgroup::"
        # è®°å½•ä¸€äº› Git ä¿¡æ¯ï¼Œç”¨äº Release æè¿°
        echo "COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")" >> $GITHUB_ENV
        echo "COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")" >> $GITHUB_ENV
        echo "COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")" >> $GITHUB_ENV
        echo "COMMIT_HASH=$(git show -s --date=short --format="hash: %H")" >> $GITHUB_ENV

    - name: âœ¨ Update and Install Feeds
      # **è¿™æ˜¯å…³é”®æ­¥éª¤ï¼š** æ›´æ–°å’Œå®‰è£… OpenWrt çš„è½¯ä»¶åŒ… feedsã€‚
      # å®ƒä¼šä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…çš„å®šä¹‰å’Œæ„å»ºè§„åˆ™ï¼ˆåŒ…æ‹¬ Rust ç›¸å…³çš„ä¾èµ–ï¼‰ï¼Œ
      # å¿…é¡»åœ¨ç¬¬ä¸€æ¬¡ `make defconfig` ä¹‹å‰æ‰§è¡Œï¼Œç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®Œæ•´ã€‚
      run: |
        echo "::group::Updating and installing feeds"
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "::endgroup::"

    - name: âš™ï¸ Prepare Configuration
      # å‡†å¤‡ .config æ–‡ä»¶ï¼Œå®ƒæ˜¯ç¼–è¯‘çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ã€‚
      # 1. æ‹·è´ä½ çš„è‡ªå®šä¹‰ .config æ–‡ä»¶åˆ° OpenWrt æºç æ ¹ç›®å½•ã€‚
      # 2. è¿è¡Œ `make defconfig` æ¥ç”Ÿæˆå®Œæ•´çš„é…ç½®ï¼Œå¡«è¡¥ç¼ºå¤±çš„é»˜è®¤é¡¹ã€‚
      run: |
        echo "::group::Preparing configuration"
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig # æ ¹æ® .config æ–‡ä»¶å’Œ feeds ç”Ÿæˆå®Œæ•´çš„é…ç½®
        # æå–ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œç”¨äºåç»­å‘½åå’Œå‘å¸ƒ
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        echo "::endgroup::"

    - name: âš¡ Cache Toolchain and DL (Optional)
      # ç¼“å­˜å·¥å…·é“¾å’Œä¸‹è½½çš„è½¯ä»¶åŒ…ï¼Œæ˜¾è‘—åŠ é€Ÿåç»­ç¼–è¯‘ã€‚
      # ä½¿ç”¨ HiGarfield/cachewrtbuild ç®€åŒ–ç¼“å­˜é€»è¾‘ã€‚
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false # æ˜¯å¦ç¼“å­˜ ccacheï¼Œæ ¹æ®éœ€æ±‚å¼€å¯
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: â• Apply Custom Modifications (DIY Script)
      # è¿è¡Œä½ çš„è‡ªå®šä¹‰è„šæœ¬ï¼Œè¿›è¡Œé¢å¤–çš„ä¿®æ”¹ï¼Œä¾‹å¦‚ï¼š
      # æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶åŒ…ã€åº”ç”¨è¡¥ä¸ã€ä¿®æ”¹é»˜è®¤ IP ç­‰ã€‚
      run: |
        echo "::group::Applying custom modifications"
        cd $OPENWRT_PATH
        # å¦‚æœä½ çš„è‡ªå®šä¹‰æ–‡ä»¶æˆ–ç›®å½•å­˜åœ¨ï¼Œå¯ä»¥ç§»åŠ¨å®ƒä»¬
        [ -e files ] && mv files $OPENWRT_PATH/files
        # ç¡®ä¿ DIY è„šæœ¬å¯æ‰§è¡Œ
        chmod +x $GITHUB_WORKSPACE/$DIY_SCRIPT
        # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        # å¦‚æœ DIY_SCRIPT ä¸­æœ‰ä¾èµ–å…¶ä»–è„šæœ¬ï¼Œç¡®ä¿å®ƒä»¬ä¹Ÿå­˜åœ¨ä¸”å¯æ‰§è¡Œ
        # chmod +x $GITHUB_WORKSPACE/scripts/*.sh
        # $GITHUB_WORKSPACE/scripts/preset-clash-core.sh $CLASH_KERNEL
        # $GITHUB_WORKSPACE/scripts/preset-terminal-tools.sh
        # $GITHUB_WORKSPACE/scripts/preset-adguard-core.sh $CLASH_KERNEL
        echo "::endgroup::"

    - name: ğŸ“¦ Download all packages
      # ä¸‹è½½æ‰€æœ‰ç¼–è¯‘æ‰€éœ€çš„è½¯ä»¶åŒ…æºç ã€‚
      # æå‰ä¸‹è½½å¯ä»¥é¿å…ç¼–è¯‘è¿‡ç¨‹ä¸­å› ç½‘ç»œé—®é¢˜å¯¼è‡´çš„å¤±è´¥ï¼Œå¹¶åˆ©ç”¨ç¼“å­˜ã€‚
      run: |
        echo "::group::Downloading packages"
        cd $OPENWRT_PATH
        # å†æ¬¡è¿è¡Œ defconfig ä»¥ç¡®ä¿æ‰€æœ‰è‡ªå®šä¹‰è„šæœ¬ä¿®æ”¹çš„é…ç½®ç”Ÿæ•ˆ
        make defconfig
        # ä¸‹è½½æ‰€æœ‰æºç åŒ…ï¼Œ-j$(nproc) ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒå¹¶è¡Œä¸‹è½½
        make download -j$(nproc)
        # æ¸…ç†ä¸‹è½½ç›®å½•ä¸­çš„ä¸å®Œæ•´æˆ–æŸåæ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "::endgroup::"

    - name: ğŸ› ï¸ Compile the Firmware
      # æ­£å¼ç¼–è¯‘ OpenWrt å›ºä»¶çš„æ ¸å¿ƒæ­¥éª¤ã€‚
      id: compile # è®¾ç½® IDï¼Œæ–¹ä¾¿åç»­æ­¥éª¤å¼•ç”¨å…¶çŠ¶æ€
      run: |
        echo "::group::Compiling firmware"
        cd $OPENWRT_PATH
        # å¯é€‰ï¼šæ·»åŠ ä¸€äº›åˆå§‹è®¾ç½®è„šæœ¬åˆ°å›ºä»¶ä¸­
        mkdir -p files/etc/uci-defaults
        # cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/99-init-settings

        echo "Compiling with $(nproc) threads..."
        # å°è¯•å¹¶è¡Œç¼–è¯‘ï¼Œå¦‚æœå¤±è´¥åˆ™å›é€€åˆ°å•çº¿ç¨‹ç¼–è¯‘ï¼Œå†å¤±è´¥åˆ™å›é€€åˆ°è¯¦ç»†æ—¥å¿—çš„å•çº¿ç¨‹ç¼–è¯‘
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "::endgroup::"
        # è®°å½•ç¼–è¯‘çŠ¶æ€å’Œæ—¥æœŸï¼Œç”¨äºåç»­æ­¥éª¤
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
        # å°è¯•ä» manifests æ–‡ä»¶ä¸­æå–å†…æ ¸ç‰ˆæœ¬
        echo "KERNEL=$(cat $OPENWRT_PATH/bin/targets/*/*/openwrt-*-kernel.bin.manifest 2>/dev/null | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
        echo "FIRMWARE_PATH=$OPENWRT_PATH/bin/targets/${DEVICE_TARGET}/${DEVICE_SUBTARGET}" >> $GITHUB_ENV


    - name: ğŸ“Š Check Space Usage (Optional)
      # ç¼–è¯‘å®Œæˆåæ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled()) # å¦‚æœç¼–è¯‘è¢«å–æ¶ˆï¼Œåˆ™ä¸æ‰§è¡Œæ­¤æ­¥éª¤
      run: df -hT

    - name: ğŸ—‚ï¸ Organize Files for Upload
      # æ•´ç†ç¼–è¯‘åçš„æ–‡ä»¶ï¼Œæ–¹ä¾¿ä¸Šä¼ å’Œå‘å¸ƒã€‚
      if: steps.compile.outputs.status == 'success'
      run: |
        echo "::group::Organizing files"
        cd $FIRMWARE_PATH # è¿›å…¥å›ºä»¶ç›®å½•
        # æ‰“å°æ ¡éªŒå’Œ
        cat sha256sums
        # æ‹·è´ .config åˆ°å›ºä»¶ç›®å½•
        cp $OPENWRT_PATH/.config build.config
        # ç§»åŠ¨æ‰€æœ‰ç”Ÿæˆçš„ .ipk åŒ…åˆ° packages å­ç›®å½•ï¼Œå¹¶æ‰“åŒ…
        mkdir -p packages
        find $OPENWRT_PATH/bin/packages -name "*.ipk" -exec mv -f {} packages/ \;
        tar -zcf Packages.tar.gz packages
        # æ¸…ç†ä¸€äº›ä¸éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
        rm -rf packages feeds.buildinfo version.buildinfo
        echo "::endgroup::"

    - name: â¬†ï¸ Upload Bin Directory (Optional)
      # å¦‚æœéœ€è¦ï¼Œä¸Šä¼ æ•´ä¸ª bin ç›®å½•ä½œä¸º GitHub Artifactsã€‚
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: ğŸ“¤ Upload Firmware To Artifacts
      # ä¸Šä¼ å›ºä»¶åˆ° GitHub Actions Artifacts (ä¸´æ—¶å­˜å‚¨)ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•ã€‚
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}/* # ä¸Šä¼ æ•´ä¸ªå›ºä»¶ç›®å½•å†…å®¹

    - name: ğŸ“¦ Create Release and Upload Firmware
      # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶åˆ° Release é¡µé¢ã€‚
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true # å…è®¸æ›´æ–°åŒå Release
        tag: ${{ env.FIRMWARE_TAG }} # Release çš„æ ‡ç­¾
        token: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ Tokenï¼Œç”¨äºå‘å¸ƒ Release
        artifacts: ${{ env.FIRMWARE_PATH }}/* # ä¸Šä¼ å›ºä»¶ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        body: | # Release çš„æè¿°ä¿¡æ¯
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**

          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - ğŸ’» å¹³å°æ¶æ„: ${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}
          - ğŸŒ é»˜è®¤åœ°å€: 192.168.1.1
          - ğŸ”‘ é»˜è®¤å¯†ç : password

          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.COMMIT_AUTHOR }}
          - ${{ env.COMMIT_DATE }}
          - ${{ env.COMMIT_MESSAGE }}
          - ${{ env.COMMIT_HASH }}
